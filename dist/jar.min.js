/*! jar - v0.1.0 - 2012-06-29
* Copyright (c) 2012 Oleg; Licensed MIT, GPL */
!function(){var a,b=/[^A-Za-z0-9]/g,c=window.storageInfo||window.webkitStorageInfo,d="".toString,e={xml:["sql","lc"],json:["sql","lc"],javascript:["sql","lc"],text:["websql","lc"]};c&&(e.xml=["fs","idb"].concat(e.xml),e.json=["idb"].concat(e.json),e.javascript=["fs"].concat(e.javascript),e.text=["idb","lc"]),a=this.jar=function f(a,b){return new f.fn.init(a,b)},a.order=e,a.prefixes={storageInfo:c},a.prototype=this.jar.fn={constructor:a,storages:[],types:["xml","html","javascript","text","json"],init:function(a,c){return this.name=a?a.replace(b,"repl"):"jar",this.deferreds={},this.stores={},c||(this.order=e),this.setup(c||this.storages)},setup:function(b){this.storages=b=b.split?b.split(" "):b;var c,d=this.register(),e=[];if(!window.localStorage)return d.reject(),this;for(var f=0,g=b.length;f<g;f++)c=b[f],e.push(this[c](this.name,this)),this.log(c);if(!this.order){this.order={};for(f=0,g=this.types.length;f<g;f++)this.order[this.types[f]]=b}return a.when.apply(a,e).done(function(){d.resolve()}).fail(function(){d.reject()}),this}},a.fn.init.prototype=a.fn,a.type=function(a){if(!a||d===a.toString)return"text";var b=(a.ownerDocument||a).documentElement;return b&&b.nodeName.toLowerCase()!=="html"?"xml":a.nodeType?"html":typeof a=="object"?"json":"text"}}.call(window),!function(){function c(){a["jar-meta"]=jar.rFilters.json(jar.data)}var a=localStorage,b=a["jar-meta"];jar.data=b?jar.filters.json(b):{},window.onbeforeunload?window.attachEvent?window.attachEvent("onbeforeunload",c):window.addEventListener("onbeforeunload",c,!1):(window.history.navigationMode="compatible",window.addEventListener("unload",c,!1)),this.log=function(a,b,c){var d;return jar.data[this.name]||(jar.data[this.name]={_storages:{},_length:0}),d=jar.data[this.name],b?(d[a]={storage:b,type:c},d._length++):b=a,d._storages[b]||(d._storages[b]=0),d._storages[b]++,this},this.removeRecord=function(a){var c,d=jar.data[this.name];return b?(c=b._storages,delete b[a],b._length--,--b._storages[c]||delete b._storages[c],this):this},this.meta=function(a){var b;if(b=jar.data[this.name])return b[a]}}.call(jar.fn),!function(){var gEval=window.execScript||eval;this.filters={json:JSON.parse,javascript:function(a){return gEval(a),a},xml:function(a){if(typeof a!="string"||!a)return null;var b;try{window.DOMParser?b=(new window.DOMParser).parseFromString(a,"text/xml"):(b=new window.ActiveXObject("Microsoft.XMLDOM"),b.async="false",b.loadXML(a))}catch(c){}if(!b||!b.documentElement||b.getElementsByTagName("parsererror").length)throw"Invalid XML: "+a;return b},text:function(a){return a},html:function(){var a=document.implementation.createHTMLDocument("").documentElement;return function(b){return a.innerHTML=b,a.firstElementChild}}()},this.executable={javascript:!0},this.text={json:JSON.stringify,xml:function(a){return typeof a!="string"?(new window.XMLSerializer).serializeToString(a):a},text:function(a){return a}},this.text.javascript=this.text.text,this.text.html=this.text.xml}.call(jar),!function(){this.prefixes={requestFileSystem:window.requestFileSystem||window.webkitRequestFileSystem,storageInfo:window.storageInfo||window.webkitStorageInfo,Blob:window.BlobBuilder||window.WebKitBlobBuilder||window.Blob,indexedDB:window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.msIndexedDB,IDBTransaction:window.IDBTransaction||window.webkitIDBTransaction,IDBKeyRange:window.IDBKeyRange||window.webkitIDBKeyRange},this.prefixes.idb=this.prefixes.indexedDB,this.prefixes.lc=localStorage}.call(jar),!function(){function d(){return this.lists={done:[],fail:[],always:[]},this.length=0,this.state="pending",this}var a,b=0,c=[].slice;d.prototype={constructor:d,add:function(a,b,c){var d;c=c||jar;if(!b)return this;if(this.state!="pending"){if(this.state=="resolved"&&a=="done")return b.apply(c,this.args),this;if(this.state=="rejected"&&a=="fail")return b.apply(c,this.args),this;a=="always"&&b.apply(c,this.args)}return this.lists[a].push({fn:b,context:c}),this},iterate:function(a,b,c){var d,e,f=a=="always";c=c||0,a=this.lists[a];for(var g=a.length;c<g;c++)d=a[c],d.fn.apply(d.context||this,b),!f&&(e=this.lists.always[c])&&e.fn.apply(d.context||this,b);return c<this.lists.always.length&&this.iterate("always",b,c),this},resolve:function(a){return this.state=="pending"&&(this.state="resolved",this.iterate("done",this.args=a)),this},reject:function(a){return this.state=="pending"&&(this.state="rejected",this.iterate("fail",this.args=a)),this},done:function(a,b){return this.add("done",a,b||this.context)},always:function(a,b){return this.add("always",a,b||this.context)},fail:function(a,b){return this.add("fail",a,b||this.context)}},this.Deferred=function(){return new d},this.when=function(){function d(){a.state=="pending"&&c==++b&&a.resolve()}function e(){a.reject()}var a=jar.Deferred(),b=0,c=arguments.length;a.context=this;if(!c)return a.resolve();for(var f=0;f<c;f++)arguments[f].always(d,this).fail(e,this);return a},this.resolve=function(a){var b=typeof a=="object"?a.id:a,d=c.call(arguments);return a=this.deferreds[b],d.shift(),delete this.deferreds[b],a.resolve(d)},this.reject=function(a){var b=typeof a=="object"?a.id:a,d=c.call(arguments);return a=this.deferreds[b],d.shift(),delete this.deferreds[b],a.reject(d)},this.fn.register=function(){var a=(new Date).getTime()+ ++b;return this.active=this.deferreds[a]=jar.deferreds[a]=jar.Deferred(),this.active.id=a,this.active},this.fn.done=function(a,b){return this.active.add("done",a,b||this),this},this.fn.fail=function(a,b){return this.active.add("fail",a,b||this),this},this.fn.always=function(a,b){return this.active.add("always",a,b||this),this},this.deferreds={},this.fn.promise=function(){var a=jar.Deferred(),b=[];for(var c in this.deferreds)a=this.deferreds[c],a.state=="pending"?b.push(a):delete this.deferreds[c];return jar.when.apply(this,b)}}.call(jar),!function(){this.set=function(a,b,c){c=c||jar.type(b);var d,e=this.register(),f=this.order[c];for(var g=0,h=this.order[c].length;g<h;g++){d=f[g];if(this[f[g]]){d=f[g];break}}return e.done(function(){this.log(a,d,c)},this),this[d].set.apply(this,[a,b,c,e.id])},this.get=function(a){var b=this.meta(a),c=this.register().id;return b?this[b.storage].get.apply(this,[a,b.type,c]):(jar.reject(c),this)},this.remove=function(a){if(!arguments.length)return delete this.order,this.clear(!0);var b=this.meta(a),c=this.register(),d=c.id;return b&&this[b.storage]?(c.done(function(){this.removeRecord(a)},this),this[b.storage].remove.apply(this,[a,d])):(window.setTimeout(function(){jar.resolve(d)}),this)},this.clear=function(a){var b,c,d=jar.data[this.name],e=this.register(),f=[];if(!d._length&&!a)return window.setTimeout(function(){e.resolve()}),this;for(var g in d._storages)b=this.register(),f.push(b),this[g].clear.apply(this,[b.id,a]);return a?c=jar.when.apply(this,f).done(function(){delete jar.data[this.name]}):c=jar.when.apply(this,f).done(function(){jar.data[this.name]={_storages:{},_length:0}}),c.done(function(){e.resolve()}).fail(function(){e.reject()}),this}}.call(jar.fn),!function(){if(!jar.prefixes.storageInfo)return;var a,b,c=jar.prefixes.requestFileSystem=window.requestFileSystem||window.webkitRequestFileSystem,d=jar.prefixes.Blob=window.BlobBuilder||window.WebKitBlobBuilder||window.Blob,e={javascript:"application/javascript",xml:"application/xml",html:"text/html",text:"text/plain"},f=window.location.origin,g={};g.xml=function(a,b,c){var d=new XMLHttpRequest;d.open("get","filesystem:"+f+"/temporary/"+a+"/"+b,!1),d.send(),d.readyState===4?jar.resolve(c,d.responseXML||d.responseText,"xml","fs"):jar.reject(c)},this.storages.push("fs"),this.fs=function(b,c){return new a.init(b,c)},b=jar.fs={},a=this.fs.prototype={constructor:this.fs,init:function(a,b){return this.name=a,this.def=jar.Deferred(),this.setup().def.done(function(){b.stores.fs=this.dir},this)},setup:function(){function f(){e.reject()}var a=this,d=this.name,e=this.def;return c(0,0,function(c){(b.db=c.root).getDirectory(d,{create:!0},function(b){a.dir=b,e.resolve()},f)},f),this}},a.init.prototype=a,this.fs.set=function(a,b,c,f){function g(){jar.reject(f)}return this.stores.fs.getFile(a,{create:!0},function(a){a.createWriter(function(a){var h=new d;a.onwriteend=function(){jar.resolve(f,c,"fs")},a.onerror=g,typeof b!="string"&&(b=jar.text[c](b)),h.append(b),a.write(h.getBlob(e[c]))},g)},g),this},this.fs.get=function(a,b,c){function d(){jar.reject(c)}var e=this.meta(a);return b=e&&e.type,g[b]?(g[b](this.name,a,c),this):(this.stores.fs.getFile(a,{},function(a){a.file(function(a){var e=new FileReader;e.onload=function(){jar.resolve(c,jar.filters[b](this.result),b,"fs")},e.onerror=d,e.readAsText(a)},d)},d),this)},this.fs.remove=function(a,b){function c(){jar.reject(b)}return this.stores.fs.getFile(a,{create:!1},function(a){a.remove(function(){jar.resolve(b)},c)},c),this},this.fs.clear=function(a,c){function e(){jar.reject(a)}var d=this;return this.stores.fs.removeRecursively(function(f){c?(delete d.stores.fs,jar.resolve(a)):b.db.getDirectory(d.name,{create:!0},function(b){d.stores.fs=b,jar.resolve(a)},e)},e),this}}.call(jar.fn)