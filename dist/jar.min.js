/*! jar - v0.1.0 - 2012-07-16
* Copyright (c) 2012 Oleg; Licensed MIT, GPL */
!function(){var a,b=/[^\w]/g,c=window.storageInfo||window.webkitStorageInfo,d="".toString,e=["sql","lc"],f={xml:e,html:e,json:e,javascript:e,css:e,text:e};c?(f.xml=["fs","idb"].concat(f.xml),f.json=["idb"].concat(f.json),f.javascript=["fs"].concat(f.javascript),f.javascript=["css"].concat(f.javascript),f.text=["idb","lc"]):window.msIndexedDB&&(f.xml=["idb"].concat(f.xml),f.json=["idb"].concat(f.json),f.javascript=["idb"].concat(f.javascript),f.css=["css"].concat(f.css),f.text=["idb","lc"]),f.js=f.javascript,a=this.jar=function g(a,b){return new g.fn.init(a,b)},a.order=f,a.prefixes={storageInfo:c},a.prototype=this.jar.fn={constructor:a,version:0,storages:[],types:["xml","html","javascript","js","css","text","json"],init:function(c,d){return this.name=c?c.replace(b,"repl"):"jar",this.deferreds={},this.stores={},d||(this.order=a.order),this.setup(d||this.storages)},setup:function(b){this.storages=b=b.split?b.split(" "):b;var c,d=this.register(),e=[];if(!window.localStorage)return d.reject(),this;for(var f=0,g=b.length;f<g;f++)c=b[f],this[c]&&(e.push(this[c](this.name,this)),this.log(c));if(!this.order){this.order={};for(f=0,g=this.types.length;f<g;f++)this.order[this.types[f]]=b}return a.when.apply(a,e).done(function(){d.resolve()}).fail(function(){d.reject()}),this}},a.fn.init.prototype=a.fn,a.has=function(c,d){return!!a.fn.meta(d,c.replace(b,"repl"))}}.call(window),!function(){var xml,head=document.head||document.getElementsByTagName("head")[0],gEval=window.execScript||eval;window.XMLSerializer?xml=function(a){return typeof a!="string"?a.xml||(new window.XMLSerializer).serializeToString(a):a}:xml=function(a){return a.xml?a.xml:a.outerHTML||a},this.filters={json:JSON.parse,javascript:function(a){return gEval(a),a},css:function(a){var b=document.createElement("style");return b.styleSheet===undefined?b.innerHTML=a:(b.type="text/css",b.styleSheet.cssText=a),head.appendChild(b),a},xml:function(a){var b;if(typeof a!="string"||!a)return null;try{window.DOMParser?b=(new window.DOMParser).parseFromString(a,"text/xml"):(b=new window.ActiveXObject("Microsoft.XMLDOM"),b.async="false",b.loadXML(a))}catch(c){}if(!b||!b.documentElement||b.getElementsByTagName("parsererror").length)throw"Invalid XML: "+a;return b},text:window.String,html:function(){var a=document.createElement("div");return function(b){return a.innerHTML=b,a.firstChild}}()},this.filters.js=this.filters.javascript,this.text={json:JSON.stringify,xml:xml,text:window.String},this.text.js=this.text.javascript=this.text.css=this.text.text,this.text.html=this.text.xml,jar.type=function(a){var b,c;if(typeof a=="string")return"text";if(!a)return;return b=(a.ownerDocument||a).documentElement,c=b&&b.nodeName.toLowerCase(),c?c!=="html"?"xml":"html":typeof a=="object"?"json":"text"}}.call(jar),!function(){this.prefixes={requestFileSystem:window.requestFileSystem||window.webkitRequestFileSystem,storageInfo:window.storageInfo||window.webkitStorageInfo,Blob:window.BlobBuilder||window.WebKitBlobBuilder||window.Blob,indexedDB:window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.msIndexedDB,IDBTransaction:window.IDBTransaction||window.webkitIDBTransaction,IDBKeyRange:window.IDBKeyRange||window.webkitIDBKeyRange},this.prefixes.idb=this.prefixes.indexedDB,this.prefixes.lc=localStorage}.call(jar),!function(){function d(){return this.lists={done:[],fail:[],always:[]},this.length=0,this.state="pending",this}var a,b=0,c=[].slice;d.prototype={constructor:d,add:function(a,b,c){var d;c=c||jar;if(!b)return this;this.args||(this.args=[]);if(this.state!="pending"){if(this.state=="resolved"&&a=="done")return b.apply(c,this.args),this;if(this.state=="rejected"&&a=="fail")return b.apply(c,this.args),this;a=="always"&&b.apply(c,this.args)}return this.lists[a].push({fn:b,context:c}),this},iterate:function(a,b,c){var d,e,f=a=="always";c=c||0,b=b||[],a=this.lists[a];for(var g=a.length;c<g;c++)d=a[c],d.fn.apply(d.context||this,b),!f&&(e=this.lists.always[c])&&e.fn.apply(d.context||this,b);return c<this.lists.always.length&&this.iterate("always",b,c),this},resolve:function(a){return this.state=="pending"&&(this.state="resolved",this.iterate("done",this.args=a)),this},reject:function(a){return this.state=="pending"&&(this.state="rejected",this.iterate("fail",this.args=a)),this},done:function(a,b){return this.add("done",a,b||this.context)},always:function(a,b){return this.add("always",a,b||this.context)},fail:function(a,b){return this.add("fail",a,b||this.context)},then:function(a,b,c){return typeof b=="function"?this.add("done",a,c||this.context).add("fail",b,c||this.context):this.add("done",a,b||this.context),this}},this.Deferred=function(){return new d},this.when=function(){function g(b,g){e[b]=c.call(g),a.state=="pending"&&f==++d&&a.resolve(e)}function h(){a.reject(c.call(arguments))}function i(a){return function(){g(a,arguments)}}var a=jar.Deferred(),b=arguments,d=0,e=[],f=b.length;a.context=this;if(!f)return a.resolve();for(var j=0;j<f;j++)b[j].always(i(j),this).fail(h,this);return a},this.resolve=function(a){var b=typeof a=="object"?a.id:a,d=c.call(arguments);return a=this.deferreds[b],d.shift(),delete this.deferreds[b],a.resolve(d)},this.reject=function(a){var b=typeof a=="object"?a.id:a,d=c.call(arguments);return a=this.deferreds[b],d.shift(),delete this.deferreds[b],a.reject(d)},this.fn.register=function(){var a=(new Date).getTime()+ ++b;return this.active=this.deferreds[a]=jar.deferreds[a]=jar.Deferred(),this.active.id=a,this.active},this.fn.done=function(a,b){return this.active.add("done",a,b||this),this},this.fn.fail=function(a,b){return this.active.add("fail",a,b||this),this},this.fn.always=function(a,b){return this.active.add("always",a,b||this),this},this.fn.then=function(){return this.active.then.apply(this.active,arguments),this},this.deferreds={},this.fn.promise=function(){var a=jar.Deferred(),b=[];for(var c in this.deferreds)a=this.deferreds[c],a.state=="pending"?b.push(a):delete this.deferreds[c];return jar.when.apply(this,b)}}.call(jar),!function(){function a(a,b,c){var d=jar.Deferred(),e=window.XMLHttpRequest?new window.XMLHttpRequest:new window.ActiveXObject("Microsoft.XMLHTTP");return e.open("get",b,!0),e.send(),e.onreadystatechange=function(){if(e.readyState!=4)return;e.status>=200&&e.status<300||e.status===304?jar(a).done(function(){var a=c=="xml"?e.responseXML:e.responseText;jar.filters[c](a),d.resolve([a,this]),this.set(b,a,c)}):d.reject()},d}jar.load=function(b,c,d){var e,f;return arguments.length!=3&&(d=b.split(".").pop()),d=="xsl"&&(d="xml"),c=c||"jar",jar.has(c,b)?(e=jar.Deferred(),jar(c).done(function(){this.get(b).done(function(a){e.resolve([a,this])})}),e):a(c,b,d)}}.call(jar),!function(){function c(){a["jar-meta"]=jar.text.json(jar.data),a["jar-iversion"]=jar.iversion}var a=localStorage,b=a["jar-meta"];jar.data=b=b?jar.filters.json(b):{},jar.iversion=a["jar-iversion"]||1,b._meta||(b._meta={}),window.onbeforeunload==null?window.addEventListener?window.addEventListener("beforeunload",c,!1):window.attachEvent("beforeunload",c):(window.history.navigationMode="compatible",window.addEventListener("unload",c,!1)),this.log=function(a,b,c){var d,e;return jar.data._meta[this.name]||(jar.data[this.name]={},jar.data._meta[this.name]={storages:{},length:0}),e=jar.data._meta[this.name],d=jar.data[this.name],b?(d[a]={storage:b,type:c},e.length++):b=a,e.storages[b]||(e.storages[b]=0),e.storages[b]++,this},this.removeRecord=function(a){var b,c=jar.data[this.name],d=jar.data._meta[this.name];return c?(b=d.storages,delete c[a],d.length--,--d.storages[b]||delete d.storages[b],this):this},this.meta=function(a,b){var c;if(c=jar.data[b||this.name])return c[a]}}.call(jar.fn),!function(){function n(a,c){if(b.db&&b.db.setVersion){if(!b.setVersion||b.setVersion.readyState==2)b.setVersion=b.db.setVersion(r());b.setVersion.addEventListener("success",a)}else b.open.readyState=="pending"?b.setVersion=b.open:b.setVersion=i.open("jar",r()),b.setVersion.addEventListener("upgradeneeded",function(){c.stores.idb=b.db=this.result,a.apply(this,arguments)});return b.setVersion.addEventListener("success",function(){this.result.onversionchange=function(){this.close()}}),b.setVersion.addEventListener("blocked",function(){b.db&&b.db.close()}),b.setVersion}function o(a){var b=n(function(){q(a.name)});b.addEventListener("success",function(){a.def.resolve()}),b.addEventListener("blocked",function(){a.def.reject()}),b.addEventListener("error",function(){a.def.reject()})}function p(a){return b.db&&b.db.objectStoreNames.contains(a)}function q(a){p(a)||b.db.createObjectStore(a,{keyPath:"name"}).createIndex("name","name",{unique:!0})}function r(){return window.msIndexedDB?jar.iversion=window.eval((+jar.iversion+1).toString()):jar.iversion=Date.now()+ ++e,jar.iversion}if(!jar.prefixes.indexedDB)return;var a,b,c=this,d={},e=0,f=[].indexOf,g={xml:!0,xsl:!0,html:!0},h={javascript:!0,js:!0,css:!0},i=jar.prefixes.indexedDB=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.msIndexedDB,j=jar.prefixes.IDBTransaction=window.IDBTransaction||window.webkitIDBTransaction,k=jar.prefixes.IDBKeyRange=window.IDBKeyRange||window.webkitIDBKeyRange,l=j.READ_WRITE||"readwrite",m=j.READ_ONLY!==0?"readonly":0;this.storages.push("idb"),this.idb=function(b){return new a.init(b,this)},b=jar.idb={},a=this.idb.prototype={constructor:this.idb,init:function(a,b){var c,d,e,f=this;return this.instance=b,this.def=jar.Deferred(),this.name=a,this.setup().def},setup:function(){function e(){c.def.reject()}var a,c=this,d=this.name;return b.open||(b.open=i.open("jar",r())),b.db&&(c.instance.stores.idb=b.db),b.open.onupgradeneeded===null?(a=n(function(){c.instance.stores.idb=b.db=this.result,q(d)},this.instance),a.addEventListener("success",function(){c.def.resolve()})):(b.db&&o(this),(a=b.open).addEventListener("success",function(){c.instance.stores.idb=b.db=this.result,o(c)})),a.addEventListener("error",e),this}},a.init.prototype=a,this.idb.set=function(a,c,d,e){if(!p(this.name))return jar.reject(e),this;var f,h,i=this;g[d]&&(c=jar.text[d](c)),c={name:a,data:c};try{h=b.db.transaction([this.name],l).objectStore(this.name),f=h.put(c)}catch(j){return jar.reject(e),this}return f.onsuccess=function(){jar.resolve(e,d,"idb")},f.onerror=function(){jar.reject(e)},this},this.idb.get=function(a,c,d){if(!p(this.name))return jar.reject(d),this;var e,f,i,j=this;try{e=b.db.transaction([this.name],m).objectStore(this.name),f=e.index("name"),i=f.get(a)}catch(k){return jar.reject(d),this}return i.onsuccess=function(){var a=this.result&&this.result.data;if(!a)return jar.reject(d);g[c]&&(a=jar.filters[c](a)),h[c]&&jar.filters[c](a),jar.resolve(d,a,c,"idb")},i.onerror=function(){jar.reject(d)},this},this.idb.remove=function(a,c){if(!p(this.name))return jar.reject(c),this;var d,e,f=this;try{e=b.db.transaction([this.name],l).objectStore(this.name),d=e["delete"](a)}catch(g){return jar.reject(c),this}return d.onsuccess=function(){jar.resolve(c)},d.onerror=function(){jar.reject(c)},this},this.idb.clear=function(a,c){function h(){jar.resolve(a)}function i(){jar.reject(a)}var d,e,f=this.stores,g=this.name;try{c?d=n(function(){b.db.deleteObjectStore(g)},this):(e=b.db.transaction([g],l).objectStore(g),d=e.clear()),d.onsuccess=h,d.onerror=i}catch(j){i()}return this}}.call(jar.fn),!function(){if(!jar.prefixes.storageInfo)return;var a,b,c=jar.prefixes.requestFileSystem=window.requestFileSystem||window.webkitRequestFileSystem,d=jar.prefixes.Blob=window.BlobBuilder||window.WebKitBlobBuilder||window.Blob,e={javascript:"application/javascript",xml:"application/xml",html:"text/html",text:"text/plain"},f=window.location.origin,g={};g.xml=function(a,b,c){var d=new window.XMLHttpRequest;d.open("get","filesystem:"+f+"/temporary/jar/"+a+"/"+b,!0),d.send(),d.onreadystatechange=function(){if(d.readyState!=4)return;d.status>=200&&d.status<300||d.status===304?jar.resolve(c,d.responseXML,"xml","fs"):jar.reject(c)}},e.js=e.javascript,this.storages.push("fs"),this.fs=function(b,c){return new a.init(b,c)},b=jar.fs={},a=this.fs.prototype={constructor:this.fs,init:function(a,b){return this.name=a,this.instance=b,this.def=jar.Deferred(),this.setup().def},setup:function(){function f(){e.reject()}var a=this,d=this.name,e=this.def;return c(0,0,function(c){(b.db=c.root).getDirectory("jar",{create:!0},function(b){a.instance.stores.fs=b,b.getDirectory(d,{create:!0},function(a){b.sub=a,e.resolve()})},f)},f),this}},a.init.prototype=a,this.fs.set=function(a,b,c,f){function g(){jar.reject(f)}return a=a.replace(/\//g,"|"),this.stores.fs.sub.getFile(a,{create:!0},function(a){a.createWriter(function(a){var h=new d;a.onwriteend=function(){jar.resolve(f,c,"fs")},a.onerror=g,typeof b!="string"&&(b=jar.text[c](b)),h.append(b),a.write(h.getBlob(e[c]))},g)},g),this},this.fs.get=function(a,b,c){function d(){jar.reject(c)}var e=this.meta(a);return b=e&&e.type,a=a.replace(/\//g,"|"),g[b]?(g[b](this.name,a,c),this):(this.stores.fs.sub.getFile(a,{},function(a){a.file(function(a){var e=new FileReader;e.onload=function(){jar.resolve(c,jar.filters[b](this.result),b,"fs")},e.onerror=d,e.readAsText(a)},d)},d),this)},this.fs.remove=function(a,b){function c(){jar.reject(b)}return this.stores.fs.sub.getFile(a,{create:!1},function(a){a.remove(function(){jar.resolve(b)},c)},c),this},this.fs.clear=function(a,c){function e(){jar.reject(a)}var d=this;return this.stores.fs.sub.removeRecursively(function(f){c?jar.resolve(a):b.db.getDirectory(d.name,{create:!0},function(b){d.stores.fs.sub=b,jar.resolve(a)},e)},e),this}}.call(jar.fn),!function(){function c(a){var c=b.call(arguments);c.shift(),window.setTimeout(function(){jar[a].apply(jar,c)})}var a=window.localStorage,b=[].slice;if(!a)return;this.storages.push("lc"),this.lc=function(){var a=jar.Deferred();return window.setTimeout(function(){a.resolve()}),a},this.lc.set=function(b,d,e,f){try{a["jar-value-"+this.name+"-"+b]=jar.text[e](d),c("resolve",f,e,"lc")}catch(g){c("reject",f)}return this},this.lc.get=function(b,d,e){d=d||this.meta(b).type;var f,g;try{f=a["jar-value-"+this.name+"-"+b],f!==undefined?c("resolve",e,jar.filters[d](f),d,"lc"):c("reject",e)}catch(h){c("reject",e)}return this},this.lc.remove=function(b,d){try{a.removeItem("jar-value-"+this.name+"-"+b),c("resolve",d)}catch(e){c("reject",d)}return this},this.lc.clear=function(a){function f(a){return function(){this.removeRecord(a)}}var b,c=this,d=[],e=jar.data[this.name];for(var g in e)b=this.register(),d.push(b),this.lc.remove.apply(this,[g,b.id]),b.done(f(g),this);return setTimeout(function(){jar.when.apply(c,d).done(function(){jar.resolve(a)}).fail(function(){jar.reject(a)})}),this}}.call(jar.fn),!function(){var a,b;if(!window.openDatabase)return;this.storages.push("sql"),this.sql=function(b,c){return new a.init(b,c)},a=this.sql.prototype={constructor:this.sql,init:function(a,b){return this.name=a,this.def=jar.Deferred(),this.setup().def.done(function(){b.stores.sql=this.db},this)},setup:function(){function c(){a.resolve()}function d(){a.reject()}var a=this.def,b="CREATE TABLE IF NOT EXISTS "+this.name+"(name TEXT PRIMARY KEY ASC, data TEXT)";return this.db=window.openDatabase("jar","1","jar Database",0),this.db.transaction(function(a){a.executeSql(b,[],c,d)}),this}},a.init.prototype=a,this.sql.set=function(a,b,c,d){function h(){jar.resolve(d,c,"sql")}function i(){jar.reject(d)}var e="UPDATE "+this.name+" SET data = ? WHERE name = ?",f="INSERT INTO "+this.name+"(data, name) VALUES(?, ?)",g=this.stores.sql;return b=jar.text[c](b),g.transaction(function(c){c.executeSql(f,[b,a],h,function(){g.transaction(function(c){c.executeSql(e,[b,a],h,i)})})}),this},this.sql.get=function(a,b,c){function f(a,d){d=d.rows;if(d.length!=1)return jar.reject(c);jar.resolve(c,jar.filters[b](d.item(0).data),b,"sql")}function g(){jar.reject(c)}var d="SELECT data FROM "+this.name+" WHERE name = '"+a+"'",e=this;return this.stores.sql.transaction(function(a){a.executeSql(d,[],f,g)}),this},this.sql.remove=function(a,b){function d(){jar.resolve(b)}function e(){jar.reject(b)}var c="DELETE FROM "+this.name+"WHERE name = ?";return this.stores.sql.transaction(function(b){b.executeSql(c,[a],d,e)}),this},this.sql.clear=function(a,b){function e(){jar.resolve(a)}function f(){jar.reject(a)}var c=this,d=b?"DROP TABLE "+this.name:"DELETE FROM "+this.name;return this.stores.sql.transaction(function(a){a.executeSql(d,[],e,f)}),this}}.call(jar.fn),!function(){function a(a){delete jar.data[a],delete jar.data._meta[a]}this.set=function(a,b,c){c=c||jar.type(b);var d,e,f=this.register();if(!this.order)return setTimeout(function(){f.reject()}),this;e=this.order[c];for(var g=0,h=this.order[c].length;g<h;g++){d=e[g];if(this[e[g]]){d=e[g];break}}return f.done(function(){this.log(a,d,c)},this),this[d].set.apply(this,[a,b,c,f.id])},this.get=function(a){var b=this.meta(a),c=this.register().id;return b?this[b.storage].get.apply(this,[a,b.type,c]):(jar.reject(c),this)},this.remove=function(a){if(!arguments.length)return delete this.order,this.clear(!0);var b=this.meta(a),c=this.register(),d=c.id;return b&&this[b.storage]?(c.done(function(){this.removeRecord(a)},this),this[b.storage].remove.apply(this,[a,d])):(window.setTimeout(function(){jar.resolve(d)}),this)},this.clear=function(b){var c,d,e,f=this,g=this.name,h=jar.data[g],i=jar.data._meta[g],j=[];if(!i||i&&!i.length)return e=this.register(),window.setTimeout(function(){b&&a(g),jar.resolve(e)}),this;for(var k in i.storages)c=this.register(),j.push(c),this[k].clear.apply(this,[c.id,b]);return b?d=jar.when.apply(this,j).done(function(){a(g)}):d=jar.when.apply(this,j).done(function(){jar.data._meta[g]={storages:{},length:0}}),e=this.register(),d.done(function(){e.resolve()}).fail(function(){e.reject()}),this}}.call(jar.fn)